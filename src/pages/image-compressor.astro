---
import BaseLayout from "../layouts/BaseLayout.astro";
import SITE from "../consts";

const pagePath = "/image-compressor";
const pageUrl = new URL(pagePath, SITE.url).toString();
const homeUrl = new URL("/", SITE.url).toString();
---

<BaseLayout
    title="Image Compressor ‚Äì JPG Sƒ±kƒ±≈ütƒ±r (HEIC/HEIF Destekli)"
    description="JPG g√∂rsellerini tarayƒ±cƒ± i√ßinde sƒ±kƒ±≈ütƒ±r. HEIC/HEIF destekli. Upload yok, √ºcretsiz."
    canonical={pagePath}
    lang="tr"
    ogImage="/og/og-image-compressor.png"
    jsonLd={[
        {
            "@type": "WebPage",
            "@id": `${pageUrl}#webpage`,
            url: pageUrl,
            name: "Image Compressor ‚Äì JPG Sƒ±kƒ±≈ütƒ±r",
            inLanguage: ["tr", "en"],
            isPartOf: { "@id": `${SITE.url}/#website` },
            about: { "@id": `${SITE.url}/#organization` },
            description:
                "JPG g√∂rsellerini tarayƒ±cƒ± i√ßinde sƒ±kƒ±≈ütƒ±r. HEIC/HEIF destekli. Upload yok, √ºcretsiz.",
            primaryImageOfPage: {
                "@type": "ImageObject",
                url: new URL(
                    "/og/og-image-compressor.png",
                    SITE.url,
                ).toString(),
                width: 1200,
                height: 630,
            },
            mainEntity: { "@id": `${pageUrl}#app` },
        },
        {
            "@type": "SoftwareApplication",
            "@id": `${pageUrl}#app`,
            name: "Image Compressor",
            applicationCategory: "MultimediaApplication",
            operatingSystem: "Web",
            url: pageUrl,
            inLanguage: ["tr", "en"],
            isAccessibleForFree: true,
            offers: { "@type": "Offer", price: "0", priceCurrency: "TRY" },
            publisher: { "@id": `${SITE.url}/#organization` },
            isPartOf: { "@id": `${SITE.url}/#website` },
            description:
                "Tarayƒ±cƒ± i√ßinde JPG sƒ±kƒ±≈ütƒ±rma aracƒ±. HEIC/HEIF dosyalarƒ±nƒ± a√ßƒ±p JPG‚Äôye √ßevirerek sƒ±kƒ±≈ütƒ±rƒ±r.",
        },
        {
            "@type": "FAQPage",
            "@id": `${pageUrl}#faq`,
            url: pageUrl,
            inLanguage: "tr",
            mainEntity: [
                {
                    "@type": "Question",
                    name: "Dosyalar sunucuya y√ºkleniyor mu?",
                    acceptedAnswer: {
                        "@type": "Answer",
                        text: "Hayƒ±r. T√ºm i≈ülem tarayƒ±cƒ±nƒ±zda yapƒ±lƒ±r.",
                    },
                },
                {
                    "@type": "Question",
                    name: "HEIC/HEIF destekli mi?",
                    acceptedAnswer: {
                        "@type": "Answer",
                        text: "Evet. HEIC/HEIF a√ßƒ±lƒ±r, JPG olarak i≈ülenir.",
                    },
                },
                {
                    "@type": "Question",
                    name: "Kaliteyi ben se√ßebilir miyim?",
                    acceptedAnswer: {
                        "@type": "Answer",
                        text: "Evet. Slider ile kalite/bitrate dengesini se√ßebilirsiniz.",
                    },
                },
            ],
        },
        {
            "@type": "BreadcrumbList",
            "@id": `${pageUrl}#breadcrumb`,
            itemListElement: [
                {
                    "@type": "ListItem",
                    position: 1,
                    name: "Anasayfa",
                    item: homeUrl,
                },
                {
                    "@type": "ListItem",
                    position: 2,
                    name: "Image Compressor",
                    item: pageUrl,
                },
            ],
        },
    ]}
>
    <header class="topbar">
        <div class="container topbar-inner">
            <nav class="nav nav-left" aria-label="Primary left">
                <a href="/" class="back-link" id="t-back">‚Üê Geri</a>
            </nav>

            <a class="brand" href="/" aria-label="Convert Tools">
                <span class="brand-mark">CT</span>
            </a>

            <div class="topbar-right">
                <nav class="nav nav-right" aria-label="Primary right">
                    <a href="/#tools" id="t-navTools">Ara√ßlar</a>
                </nav>

                <div class="lang-switch" aria-label="Language switch">
                    <button class="lang-btn" type="button" data-lang="tr"
                        >TR</button
                    >
                    <button class="lang-btn" type="button" data-lang="en"
                        >EN</button
                    >
                </div>
            </div>
        </div>
    </header>

    <section class="page" id="top">
        <div class="container">
            <div class="mini-hero" id="miniHero">
                <span class="badge" id="t-badge">√úcretsiz & Sƒ±nƒ±rsƒ±z</span>
                <h1 class="page-title" id="t-title">Image Compressor</h1>
                <p class="page-subtitle muted" id="t-sub">
                    JPG sƒ±kƒ±≈ütƒ±r. HEIC/HEIF de destekli. Upload yok, tarayƒ±cƒ±
                    i√ßinde.
                </p>

                <div class="mini-features">
                    <span id="t-f1">üóúÔ∏è Sƒ±kƒ±≈ütƒ±r</span>
                    <span id="t-f2">üîí Upload yok</span>
                    <span id="t-f3">üì± Mobil uyumlu</span>
                </div>
            </div>

            <div style="height:14px;"></div>

            <div class="panel">
                <div class="panel-head">
                    <div class="breadcrumb">
                        <a href="/" id="t-bcHome">Anasayfa</a>
                        <span class="sep">‚Ä∫</span>
                        <span id="t-bcHere">Image Compressor</span>
                    </div>
                </div>

                <input
                    id="file"
                    type="file"
                    accept="image/*,.heic,.heif"
                    hidden
                />

                <div class="upload-box" id="dropZone">
                    <div class="upload-state is-idle">
                        <div class="upload-icon">‚¨á</div>
                        <div class="upload-text">
                            <label for="file" class="choose-link">
                                <b id="t-choose">Dosya se√ß</b>
                            </label>
                            <span id="idleHint">veya buraya s√ºr√ºkle.</span>
                        </div>
                    </div>

                    <div class="upload-state is-processing" hidden>
                        <div class="upload-spinner"></div>
                        <div class="upload-text">
                            <b id="t-processing">ƒ∞≈üleniyor‚Ä¶</b>
                        </div>
                    </div>

                    <div class="upload-state is-done" hidden>
                        <div class="upload-text">
                            <span id="t-ready">Hazƒ±r!</span>
                            <a href="#" id="uploadMore" class="choose-link">
                                <b id="t-uploadMore">Ba≈üka y√ºkle?</b>
                            </a>
                        </div>
                    </div>
                </div>

                <div id="previewWrap" style="margin-top:14px;" hidden>
                    <div class="preview-head">
                        <p class="muted" style="margin:0;" id="t-previewTitle">
                            √ñnizleme
                        </p>

                        <div class="preview-actions">
                            <button
                                id="toggleView"
                                type="button"
                                class="ghost-btn"
                            >
                                <span id="t-toggle">Orijinali G√∂ster</span>
                            </button>

                            <span class="muted outfmt">
                                <span id="t-outFmt">√áƒ±ktƒ±:</span>
                                <b>JPG</b>
                            </span>
                        </div>
                    </div>

                    <div class="preview-frame" id="previewFrame">
                        <canvas id="canvas"></canvas>
                    </div>

                    <div class="compress-controls">
                        <div class="row">
                            <p class="muted" style="margin:0;">
                                <span id="t-qualityLabel">Kalite:</span>
                                <b id="qText">75</b>
                            </p>

                            <p class="muted" style="margin:0;" id="sizeLine">
                                ‚Äî
                            </p>
                        </div>

                        <div
                            class="preset-row"
                            aria-label="Compression presets"
                        >
                            <button
                                type="button"
                                class="preset-btn"
                                data-q="35"
                                id="presetSmall">Hƒ±zlƒ± k√º√ß√ºlt</button
                            >
                            <button
                                type="button"
                                class="preset-btn is-active"
                                data-q="75"
                                id="presetBalanced">Dengeli</button
                            >
                            <button
                                type="button"
                                class="preset-btn"
                                data-q="92"
                                id="presetQuality">Kaliteyi koru</button
                            >
                        </div>

                        <input
                            id="quality"
                            type="range"
                            min="0"
                            max="100"
                            value="75"
                        />

                        <div class="size-bar" aria-label="Estimated size bar">
                            <div
                                class="size-bar-fill"
                                id="barFill"
                                style="width: 75%;"
                            >
                            </div>
                        </div>

                        <div class="row small">
                            <span class="muted" id="minText">Min: ‚Äî</span>
                            <span class="muted" id="selText">Se√ßili: ‚Äî</span>
                            <span class="muted" id="maxText">Max: ‚Äî</span>
                        </div>

                        <div class="btn-row">
                            <button id="download" type="button" hidden>
                                <span id="t-download">JPG ƒ∞ndir</span>
                            </button>
                            <button
                                id="reset"
                                type="button"
                                class="ghost-btn"
                                hidden
                            >
                                <span id="t-reset">Sƒ±fƒ±rla</span>
                            </button>
                        </div>

                        <p id="result" class="muted" style="margin-top:10px;">
                        </p>
                    </div>
                </div>
            </div>

            <div class="panel">
                <section class="seo-text" style="margin-top:18px">
                    <h2 id="t-seoH2">Saku Image Compressor Nedir?</h2>

                    <p class="seo-lead" id="t-seoLead">
                        Saku Convert ile JPG g√∂rsellerinizi tarayƒ±cƒ± i√ßinde
                        sƒ±kƒ±≈ütƒ±rƒ±n. Upload yok. HEIC/HEIF dosyalarƒ± da a√ßƒ±lƒ±r ve
                        JPG‚Äôye d√∂n√º≈üt√ºr√ºlerek k√º√ß√ºlt√ºl√ºr.
                    </p>

                    <details class="seo-details">
                        <summary id="t-seoSummary">Detaylarƒ± g√∂ster</summary>
                        <div class="details-content">
                            <p id="t-seoP1">
                                Bu ara√ß ‚Äúonline gibi‚Äù g√∂r√ºnse de t√ºm i≈ülem
                                cihazƒ±nƒ±zda ger√ßekle≈üir. Bu sayede gizlilik
                                korunur ve hƒ±zlƒ± √ßalƒ±≈üƒ±r.
                            </p>
                            <p id="t-seoP2">
                                Slider ile kaliteyi se√ßerek ‚Äú√ßok sƒ±kƒ±≈ütƒ±r‚Äù ile
                                ‚Äúkaliteyi koru‚Äù arasƒ±nda denge kurabilirsiniz.
                                √ñnizleme alanƒ±nda farkƒ± anƒ±nda g√∂r√ºrs√ºn√ºz.
                            </p>
                        </div>
                    </details>
                </section>
            </div>

            <style>
                .preview-head {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 12px;
                    flex-wrap: wrap;
                }
                .preview-actions {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    flex-wrap: wrap;
                }
                .outfmt {
                    font-weight: 850;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                }

                .ghost-btn {
                    background: rgba(255, 255, 255, 0.75);
                    color: #0f172a;
                    border: 1px solid rgba(148, 163, 184, 0.45);
                    box-shadow: 0 10px 26px rgba(15, 23, 42, 0.06);
                }
                .ghost-btn:hover {
                    transform: none;
                    filter: none;
                }

                .compress-controls {
                    margin-top: 12px;
                }
                .compress-controls .row {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 10px;
                    flex-wrap: wrap;
                }
                .compress-controls .row.small {
                    font-size: 0.9rem;
                    opacity: 0.95;
                    margin-top: 6px;
                }

                .preset-row {
                    display: flex;
                    gap: 10px;
                    flex-wrap: wrap;
                    margin: 10px 0 8px;
                }
                .preset-btn {
                    border: 1px solid rgba(120, 120, 140, 0.22);
                    background: rgba(255, 255, 255, 0.55);
                    padding: 8px 12px;
                    border-radius: 12px;
                    font-weight: 750;
                    cursor: pointer;
                    transition:
                        transform 0.08s ease,
                        background 0.12s ease,
                        border-color 0.12s ease;
                    color: #475569;
                }
                .preset-btn:hover {
                    transform: translateY(-1px);
                }
                .preset-btn.is-active {
                    border-color: rgba(90, 90, 255, 0.35);
                    background: rgba(120, 120, 255, 0.12);
                }

                .size-bar {
                    width: 100%;
                    height: 10px;
                    border-radius: 999px;
                    background: rgba(148, 163, 184, 0.22);
                    border: 1px solid rgba(148, 163, 184, 0.35);
                    overflow: hidden;
                    margin-top: 10px;
                }
                .size-bar-fill {
                    height: 100%;
                    border-radius: 999px;
                    background: linear-gradient(
                        90deg,
                        rgba(79, 70, 229, 0.7),
                        rgba(14, 165, 233, 0.55)
                    );
                }
                .btn-row {
                    display: flex;
                    gap: 12px;
                    flex-wrap: wrap;
                    margin-top: 12px;
                    align-items: center;
                }
            </style>

            <script type="module">
                import { i18n } from "/i18n.js";
                import { detectLang } from "/utils/lang.js";

                // --- heic2any: dynamic import (client only) ---
                let _heic2anyPromise = null;
                async function getHeic2any() {
                    if (!_heic2anyPromise)
                        _heic2anyPromise = import("heic2any");
                    const mod = await _heic2anyPromise;
                    return mod.default;
                }

                const lang = detectLang();
                const t = i18n[lang] || i18n.en;

                const $ = (id) => document.getElementById(id);
                const setText = (id, value) => {
                    const el = $(id);
                    if (el && value != null) el.textContent = value;
                };

                const TEXT = {
                    tr: {
                        back: "‚Üê Geri",
                        tools: "Ara√ßlar",
                        badge: "√úcretsiz & Sƒ±nƒ±rsƒ±z",
                        title: "G√∂rsel Sƒ±kƒ±≈ütƒ±rƒ±cƒ±",
                        sub: "JPG sƒ±kƒ±≈ütƒ±r. HEIC/HEIF de destekli. Upload yok, tarayƒ±cƒ± i√ßinde.",
                        f1: "üóúÔ∏è Sƒ±kƒ±≈ütƒ±r",
                        f2: "üîí Upload yok",
                        f3: "üì± Mobil uyumlu",
                        choose: "Dosya se√ß",
                        idleHint: "veya buraya s√ºr√ºkle.",
                        processing: "ƒ∞≈üleniyor‚Ä¶",
                        ready: "Hazƒ±r!",
                        uploadMore: "Ba≈üka y√ºkle?",
                        preview: "√ñnizleme",
                        toggleOriginal: "Orijinali G√∂ster",
                        toggleCompressed: "Sƒ±kƒ±≈ütƒ±rƒ±lmƒ±≈üƒ± G√∂ster",
                        quality: "Kalite:",
                        output: "√áƒ±ktƒ±:",
                        download: "JPG ƒ∞ndir",
                        reset: "Sƒ±fƒ±rla",
                        preparing: "Hazƒ±rlanƒ±yor...",
                        loaded: "G√∂rsel y√ºklendi ‚úÖ ≈ûimdi sƒ±kƒ±≈ütƒ±rmayƒ± ayarla.",
                        loadedHeic:
                            "HEIC/HEIF a√ßƒ±ldƒ± ‚úÖ ≈ûimdi sƒ±kƒ±≈ütƒ±rmayƒ± ayarla.",
                        updated: "√ñnizleme g√ºncellendi ‚úÖ",
                        downloaded: "JPG indirildi ‚úÖ",
                        errHeic:
                            "HEIC/HEIF d√∂n√º≈üt√ºr√ºlemedi. Ba≈üka bir g√∂rsel deneyin.",
                        errRead:
                            "Dosya okunamadƒ± (format desteklenmiyor olabilir).",
                        errOut: "√áƒ±ktƒ± √ºretilemedi (tarayƒ±cƒ± kƒ±sƒ±tƒ± olabilir).",
                        errCompress: "Sƒ±kƒ±≈ütƒ±rma sƒ±rasƒ±nda hata olu≈ütu.",
                        seoH2: "Saku G√∂rsel Sƒ±kƒ±≈ütƒ±rƒ±cƒ± Nedir?",
                        seoLead:
                            "Saku Convert ile JPG g√∂rsellerinizi tarayƒ±cƒ± i√ßinde sƒ±kƒ±≈ütƒ±rƒ±n. Upload yok. HEIC/HEIF dosyalarƒ± da a√ßƒ±lƒ±r ve JPG‚Äôye d√∂n√º≈üt√ºr√ºlerek k√º√ß√ºlt√ºl√ºr.",
                        seoSummary: "Detaylarƒ± g√∂ster",
                        seoP1: "Bu ara√ß ‚Äúonline gibi‚Äù g√∂r√ºnse de t√ºm i≈ülem cihazƒ±nƒ±zda ger√ßekle≈üir. Bu sayede gizlilik korunur ve hƒ±zlƒ± √ßalƒ±≈üƒ±r.",
                        seoP2: "Slider ile kaliteyi se√ßerek ‚Äú√ßok sƒ±kƒ±≈ütƒ±r‚Äù ile ‚Äúkaliteyi koru‚Äù arasƒ±nda denge kurabilirsiniz. √ñnizleme alanƒ±nda farkƒ± anƒ±nda g√∂r√ºrs√ºn√ºz.",
                        min: "Min: ",
                        max: "Max: ",
                        sel: "Se√ßili: ",
                        original: "Orijinal",
                        out: "√áƒ±ktƒ±",
                        selectedDash: "Se√ßili: ‚Äî",
                    },
                    en: {
                        back: "‚Üê Back",
                        tools: "Tools",
                        badge: "Free & Unlimited",
                        title: "Image Compressor",
                        sub: "Compress to JPG in-browser. HEIC/HEIF supported. No uploads.",
                        f1: "üóúÔ∏è Compress",
                        f2: "üîí No uploads",
                        f3: "üì± Mobile friendly",
                        choose: "Choose a file",
                        idleHint: "or drag it here.",
                        processing: "Processing‚Ä¶",
                        ready: "Ready!",
                        uploadMore: "Upload more?",
                        preview: "Preview",
                        toggleOriginal: "Show Original",
                        toggleCompressed: "Show Compressed",
                        quality: "Quality:",
                        output: "Output:",
                        download: "Download JPG",
                        reset: "Reset",
                        preparing: "Preparing...",
                        loaded: "Image loaded ‚úÖ Adjust compression.",
                        loadedHeic: "HEIC/HEIF loaded ‚úÖ Adjust compression.",
                        updated: "Preview updated ‚úÖ",
                        downloaded: "JPG downloaded ‚úÖ",
                        errHeic:
                            "Could not convert HEIC/HEIF. Try another file.",
                        errRead:
                            "Could not read file (format may be unsupported).",
                        errOut: "Could not create output (browser limitation).",
                        errCompress: "Error while compressing.",
                        seoH2: "What is Saku Image Compressor?",
                        seoLead:
                            "Compress images to JPG in your browser. No uploads. HEIC/HEIF are opened and converted to JPG.",
                        seoSummary: "Show details",
                        seoP1: "Even though it feels like an online tool, everything runs locally on your device for privacy and speed.",
                        seoP2: "Use the slider to balance file size and quality. You can preview the difference instantly.",
                        min: "Min: ",
                        max: "Max: ",
                        sel: "Selected: ",
                        original: "Original",
                        out: "Output",
                        selectedDash: "Selected: ‚Äî",
                    },
                };

                const L = TEXT[lang] || TEXT.en;

                function applyText() {
                    setText("t-back", t.back ?? L.back);
                    setText("t-navTools", t.toolsHead ?? L.tools);
                    setText("t-badge", t.badge ?? L.badge);
                    setText("t-title", L.title);
                    setText("t-sub", L.sub);
                    setText("t-f1", L.f1);
                    setText("t-f2", L.f2);
                    setText("t-f3", L.f3);

                    setText("t-bcHome", lang === "tr" ? "Anasayfa" : "Home");
                    setText("t-bcHere", "Image Compressor");

                    setText("t-choose", L.choose);
                    setText("idleHint", L.idleHint);
                    setText("t-processing", L.processing);
                    setText("t-ready", L.ready);
                    setText("t-uploadMore", L.uploadMore);

                    setText("t-previewTitle", L.preview);
                    setText("t-toggle", L.toggleOriginal);
                    setText("t-qualityLabel", L.quality);
                    setText("t-outFmt", L.output);
                    setText("t-download", L.download);
                    setText("t-reset", L.reset);

                    setText("t-seoH2", L.seoH2);
                    setText("t-seoLead", L.seoLead);
                    setText("t-seoSummary", L.seoSummary);
                    setText("t-seoP1", L.seoP1);
                    setText("t-seoP2", L.seoP2);

                    document.documentElement.lang = lang;
                }

                applyText();

                // language buttons
                const langBtns = document.querySelectorAll(".lang-btn");
                const current = localStorage.getItem("lang") || lang;
                langBtns.forEach((b) =>
                    b.classList.toggle("is-active", b.dataset.lang === current),
                );
                langBtns.forEach((btn) => {
                    btn.addEventListener("click", () => {
                        localStorage.setItem("lang", btn.dataset.lang);
                        location.reload();
                    });
                });

                // mini hero anim
                const miniHero = $("miniHero");
                requestAnimationFrame(() =>
                    miniHero?.classList.add("is-entered"),
                );

                // refs
                const fileInput = $("file");
                const dropZone = $("dropZone");

                const previewWrap = $("previewWrap");
                const previewFrame = $("previewFrame");
                const canvas = $("canvas");
                const ctx = canvas.getContext("2d", {
                    willReadFrequently: true,
                });

                const quality = $("quality");
                const qText = $("qText");
                const barFill = $("barFill");
                const minText = $("minText");
                const selText = $("selText");
                const maxText = $("maxText");

                const sizeLine = $("sizeLine");
                const result = $("result");

                const toggleViewBtn = $("toggleView");
                const downloadBtn = $("download");
                const resetBtn = $("reset");
                const uploadMore = $("uploadMore");

                const stateIdle = document.querySelector(
                    ".upload-state.is-idle",
                );
                const stateProcessing = document.querySelector(
                    ".upload-state.is-processing",
                );
                const stateDone = document.querySelector(
                    ".upload-state.is-done",
                );

                const presetBtns = document.querySelectorAll(".preset-btn");

                function showIdle() {
                    stateIdle.hidden = false;
                    stateProcessing.hidden = true;
                    stateDone.hidden = true;
                }
                function showProcessing() {
                    stateIdle.hidden = true;
                    stateProcessing.hidden = false;
                    stateDone.hidden = true;
                }
                function showDone() {
                    stateIdle.hidden = true;
                    stateProcessing.hidden = true;
                    stateDone.hidden = false;
                }

                const cleanBaseName = (name) =>
                    (name || "").replace(/\.[^.]+$/, "");
                const bytesToNice = (n) => {
                    if (n == null) return "‚Äî";
                    const kb = n / 1024;
                    if (kb < 1024) return `${Math.round(kb)} KB`;
                    return `${(kb / 1024).toFixed(2)} MB`;
                };

                function sliderToQuality(v) {
                    // 0..100 -> 0.35..0.95
                    const minQ = 0.35,
                        maxQ = 0.95;
                    return minQ + (v / 100) * (maxQ - minQ);
                }

                function resizeCanvasToFrame() {
                    const rect = previewFrame.getBoundingClientRect();
                    const dpr = window.devicePixelRatio || 1;
                    const w = Math.max(1, Math.round(rect.width * dpr));
                    const h = Math.max(1, Math.round(rect.height * dpr));
                    if (canvas.width !== w || canvas.height !== h) {
                        canvas.width = w;
                        canvas.height = h;
                    }
                }

                function drawBitmapContained(bitmap) {
                    resizeCanvasToFrame();
                    const dstW = canvas.width,
                        dstH = canvas.height;

                    const scale = Math.min(
                        dstW / bitmap.width,
                        dstH / bitmap.height,
                    );
                    const w = Math.round(bitmap.width * scale);
                    const h = Math.round(bitmap.height * scale);
                    const x = Math.round((dstW - w) / 2);
                    const y = Math.round((dstH - h) / 2);

                    ctx.clearRect(0, 0, dstW, dstH);
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = "high";
                    ctx.drawImage(bitmap, x, y, w, h);
                }

                function bitmapToJpegBlob(bitmap, q) {
                    const c = document.createElement("canvas");
                    c.width = bitmap.width;
                    c.height = bitmap.height;
                    const cctx = c.getContext("2d");
                    cctx.fillStyle = "#ffffff";
                    cctx.fillRect(0, 0, c.width, c.height);
                    cctx.drawImage(bitmap, 0, 0);

                    return new Promise((resolve) =>
                        c.toBlob((blob) => resolve(blob), "image/jpeg", q),
                    );
                }

                async function fileToBitmap(file) {
                    const name = (file.name || "").toLowerCase();
                    const isHeic =
                        name.endsWith(".heic") ||
                        name.endsWith(".heif") ||
                        file.type === "image/heic" ||
                        file.type === "image/heif";

                    let blob = file;

                    if (isHeic) {
                        try {
                            const heic2any = await getHeic2any();
                            const conv = await heic2any({
                                blob: file,
                                toType: "image/jpeg",
                                quality: 0.98,
                            });
                            blob = Array.isArray(conv) ? conv[0] : conv;
                        } catch {
                            throw new Error("heic_failed");
                        }
                    }

                    const bmp = await createImageBitmap(blob);
                    return { bmp, sizeBlob: blob, isHeic };
                }

                function setPresetActive(value) {
                    presetBtns.forEach((b) =>
                        b.classList.toggle(
                            "is-active",
                            Number(b.dataset.q) === Number(value),
                        ),
                    );
                }

                // --- state ---
                let showOriginal = false;
                let srcBitmap = null;
                let srcNameBase = "compressed";

                let originalBytes = 0;
                let minBytes = null;
                let maxBytes = null;

                let lastOutBlob = null;

                // (performance) bitmap decode is optional; decode only when needed to draw
                let lastOutBitmap = null;
                let lastOutBitmapForBytes = 0;

                function updateBar() {
                    const v = Number(quality.value);
                    barFill.style.width = `${v}%`;
                    qText.textContent = String(v);

                    minText.textContent = L.min + bytesToNice(minBytes);
                    maxText.textContent = L.max + bytesToNice(maxBytes);
                    selText.textContent = lastOutBlob
                        ? L.sel + bytesToNice(lastOutBlob.size)
                        : L.selectedDash;
                }

                function updateSizeLine() {
                    if (!originalBytes || !lastOutBlob) {
                        sizeLine.textContent = "‚Äî";
                        return;
                    }
                    const out = lastOutBlob.size;
                    const pct = Math.max(
                        0,
                        Math.round((1 - out / originalBytes) * 100),
                    );
                    const q = Math.round(
                        sliderToQuality(Number(quality.value)) * 100,
                    );

                    sizeLine.textContent =
                        lang === "tr"
                            ? `${L.original}: ${bytesToNice(originalBytes)} ‚Üí ${L.out}: ${bytesToNice(out)} (‚àí%${pct}) ¬∑ JPG Quality: ${q}`
                            : `${L.original}: ${bytesToNice(originalBytes)} ‚Üí ${L.out}: ${bytesToNice(out)} (‚àí${pct}%) ¬∑ JPG Quality: ${q}`;
                }

                async function ensureOutBitmap() {
                    if (!lastOutBlob) return null;
                    // if blob changed, bitmap must be re-decoded
                    if (
                        !lastOutBitmap ||
                        lastOutBitmapForBytes !== lastOutBlob.size
                    ) {
                        lastOutBitmap = await createImageBitmap(lastOutBlob);
                        lastOutBitmapForBytes = lastOutBlob.size;
                    }
                    return lastOutBitmap;
                }

                let debounceTimer = null;
                async function renderCompressedDebounced({
                    redraw = true,
                } = {}) {
                    clearTimeout(debounceTimer);

                    debounceTimer = setTimeout(async () => {
                        if (!srcBitmap) return;

                        try {
                            const q = sliderToQuality(Number(quality.value));
                            const blob = await bitmapToJpegBlob(srcBitmap, q);

                            if (!blob) {
                                result.textContent = L.errOut;
                                return;
                            }

                            lastOutBlob = blob;
                            // mark bitmap stale
                            lastOutBitmap = null;
                            lastOutBitmapForBytes = 0;

                            updateBar();
                            updateSizeLine();

                            // draw only if user is on compressed view and redraw requested
                            if (!showOriginal && redraw) {
                                const bmp = await ensureOutBitmap();
                                if (bmp) drawBitmapContained(bmp);
                            }

                            downloadBtn.hidden = false;
                            resetBtn.hidden = false;

                            showDone();
                            result.textContent = L.updated;
                        } catch {
                            result.textContent = L.errCompress;
                            showIdle();
                        }
                    }, 150);
                }

                function resetAll() {
                    fileInput.value = "";
                    setText("idleHint", L.idleHint);

                    previewWrap.hidden = true;
                    downloadBtn.hidden = true;
                    resetBtn.hidden = true;

                    srcBitmap = null;
                    srcNameBase = "compressed";

                    originalBytes = 0;
                    minBytes = null;
                    maxBytes = null;

                    lastOutBlob = null;
                    lastOutBitmap = null;
                    lastOutBitmapForBytes = 0;

                    showOriginal = false;
                    setText("t-toggle", L.toggleOriginal);

                    qText.textContent = quality.value;
                    barFill.style.width = `${quality.value}%`;

                    minText.textContent = L.min + "‚Äî";
                    selText.textContent = L.selectedDash;
                    maxText.textContent = L.max + "‚Äî";
                    sizeLine.textContent = "‚Äî";
                    result.textContent = "";

                    setPresetActive(quality.value);
                    showIdle();
                }

                async function setSelectedFile(file) {
                    if (!file) return;

                    // keep input in sync for drag&drop
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    fileInput.files = dt.files;

                    showProcessing();
                    result.textContent = L.preparing;

                    try {
                        const { bmp, sizeBlob, isHeic } =
                            await fileToBitmap(file);

                        srcBitmap = bmp;
                        srcNameBase = cleanBaseName(file.name || "image");
                        originalBytes = sizeBlob.size;

                        previewWrap.hidden = false;
                        downloadBtn.hidden = false;
                        resetBtn.hidden = false;

                        // quick first draw: original
                        showOriginal = true;
                        drawBitmapContained(srcBitmap);
                        setText("t-toggle", L.toggleCompressed);

                        // immediately switch to compressed mode & render
                        showOriginal = false;
                        setText("t-toggle", L.toggleOriginal);

                        result.textContent = isHeic ? L.loadedHeic : L.loaded;

                        // render current slider; redraw preview
                        await renderCompressedDebounced({ redraw: true });

                        // compute min/max in background (do not block UI)
                        (async () => {
                            try {
                                const [bMin, bMax] = await Promise.all([
                                    bitmapToJpegBlob(srcBitmap, 0.35),
                                    bitmapToJpegBlob(srcBitmap, 0.92),
                                ]);
                                minBytes = bMin?.size ?? null;
                                maxBytes = bMax?.size ?? null;
                                updateBar();
                            } catch {
                                // ignore
                            }
                        })();
                    } catch (e) {
                        const msg = String(e?.message || e || "");
                        result.textContent = msg.includes("heic_failed")
                            ? L.errHeic
                            : L.errRead;
                        resetAll();
                    }
                }

                // --- preset buttons ---
                presetBtns.forEach((btn) => {
                    btn.addEventListener("click", () => {
                        quality.value = btn.dataset.q;
                        qText.textContent = quality.value;
                        barFill.style.width = `${quality.value}%`;
                        setPresetActive(quality.value);
                        // while dragging, no need to decode bitmap each time; redraw only if already on compressed view
                        renderCompressedDebounced({ redraw: !showOriginal });
                    });
                });

                // --- events ---
                fileInput.addEventListener("change", () => {
                    const file = fileInput.files?.[0];
                    if (file) setSelectedFile(file);
                });

                ["dragenter", "dragover"].forEach((ev) => {
                    dropZone.addEventListener(ev, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropZone.classList.add("is-dragover");
                    });
                });
                ["dragleave", "dragend"].forEach((ev) => {
                    dropZone.addEventListener(ev, (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropZone.classList.remove("is-dragover");
                    });
                });
                dropZone.addEventListener("drop", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.remove("is-dragover");
                    const file = e.dataTransfer?.files?.[0];
                    if (file) setSelectedFile(file);
                });

                uploadMore.addEventListener("click", (e) => {
                    e.preventDefault();
                    resetAll();
                });

                quality.addEventListener("input", () => {
                    qText.textContent = quality.value;
                    barFill.style.width = `${quality.value}%`;
                    setPresetActive(quality.value);
                    renderCompressedDebounced({ redraw: !showOriginal });
                });

                toggleViewBtn.addEventListener("click", async () => {
                    if (!srcBitmap) return;
                    showOriginal = !showOriginal;

                    if (showOriginal) {
                        drawBitmapContained(srcBitmap);
                        setText("t-toggle", L.toggleCompressed);
                    } else {
                        // ensure current compressed bitmap exists, then draw
                        await renderCompressedDebounced({ redraw: false });
                        const bmp = await ensureOutBitmap();
                        if (bmp) drawBitmapContained(bmp);
                        setText("t-toggle", L.toggleOriginal);
                    }
                });

                downloadBtn.addEventListener("click", () => {
                    if (!lastOutBlob) return;

                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(lastOutBlob);
                    a.download = `${srcNameBase}-compressed.jpg`;
                    a.click();
                    setTimeout(() => URL.revokeObjectURL(a.href), 2000);

                    result.textContent = L.downloaded;
                    result.classList.add("success-glow");
                    setTimeout(
                        () => result.classList.remove("success-glow"),
                        950,
                    );
                });

                resetBtn.addEventListener("click", resetAll);

                window.addEventListener("resize", async () => {
                    if (previewWrap.hidden || !srcBitmap) return;
                    if (showOriginal) drawBitmapContained(srcBitmap);
                    else {
                        const bmp = await ensureOutBitmap();
                        if (bmp) drawBitmapContained(bmp);
                    }
                });

                // init
                qText.textContent = quality.value;
                barFill.style.width = `${quality.value}%`;
                setPresetActive(quality.value);
                showIdle();
            </script>
        </div>
    </section>
</BaseLayout>
