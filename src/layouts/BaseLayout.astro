---
import "/src/styles/global.css";
import SITE from "../consts";

const {
    title = SITE.name,
    description,
    canonical,
    lang = "tr",
    ogImage = SITE.defaultOgImage ?? "/og/og-default.png",
    noindex = false,
    jsonLd = null, // object | array
} = Astro.props;

const finalDescription =
    description || (lang === "tr" ? SITE.descriptionTR : SITE.descriptionEN);

// canonical normalize: "/x" veya "x" gelirse düzelt
const canonicalPath = canonical
    ? String(canonical).startsWith("/")
        ? String(canonical)
        : `/${canonical}`
    : Astro.url.pathname;

// absolute canonical
const canonicalUrl = new URL(canonicalPath, SITE.url).toString();

// absolute og image
const ogImageAbs = new URL(ogImage, SITE.url).toString();

// Title: zaten site adı geçiyorsa ekleme
const fullTitle =
    title && String(title).includes(SITE.name)
        ? String(title)
        : `${title} · ${SITE.name}`;

// (SEO) hreflang alternates: TR/EN aynı URL'de dil switch ile çalıştığı için
// "x-default" ve 2 dil için aynı canonical veriyoruz.
const absolutePath = Astro.url.pathname || "/";
const alternateTr = new URL(absolutePath, SITE.url).toString();
const alternateEn = new URL(absolutePath, SITE.url).toString();

// ------- JSON-LD helpers -------
const stripContextDeep = (input) => {
    if (!input) return input;

    if (Array.isArray(input)) return input.map(stripContextDeep).filter(Boolean);
    if (typeof input !== "object") return input;

    // yalnızca top-level @context sil
    const { ["@context"]: _ctx, ...rest } = input;
    return rest;
};

// jsonLd normalize: object | array -> array
const pageJsonLd = jsonLd ? (Array.isArray(jsonLd) ? jsonLd : [jsonLd]) : [];

// Graph item’ları (context’siz)
const baseWebSiteLd = {
    "@type": "WebSite",
    "@id": `${SITE.url}/#website`,
    name: SITE.name,
    url: SITE.url,
    inLanguage: lang,
    description: finalDescription,
    potentialAction: {
        "@type": "SearchAction",
        target: `${SITE.url}/?q={search_term_string}`,
        "query-input": "required name=search_term_string",
    },
};

const baseOrgLd = {
    "@type": "Organization",
    "@id": `${SITE.url}/#organization`,
    name: SITE.publisherName ?? "Saku Studios",
    url: SITE.url,
    logo: new URL(SITE.logo512 ?? "/android-chrome-512x512.png", SITE.url).toString(),
};

const graphItems = [
    baseWebSiteLd,
    baseOrgLd,
    ...stripContextDeep(pageJsonLd),
].filter(Boolean);

// Tek ve garantili parse edilen JSON-LD (@graph)
const jsonLdGraph =
    graphItems.length > 0
        ? {
              "@context": "https://schema.org",
              "@graph": graphItems,
          }
        : null;

// ✅ Güvenli stringify (script içine text olarak basacağız)
const jsonLdString = jsonLdGraph ? JSON.stringify(jsonLdGraph) : "";
---

<!doctype html>
<html lang={lang}>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />

        <title>{fullTitle}</title>
        <meta name="description" content={finalDescription} />
        <link rel="canonical" href={canonicalUrl} />

        <!-- hreflang (tek URL, dil storage ile değişiyor) -->
        <link rel="alternate" href={alternateTr} hreflang="tr" />
        <link rel="alternate" href={alternateEn} hreflang="en" />
        <link rel="alternate" href={alternateTr} hreflang="x-default" />

        {
            noindex ? (
                <meta name="robots" content="noindex,nofollow" />
            ) : (
                <meta name="robots" content="index,follow" />
            )
        }

        <meta name="application-name" content={SITE.name} />
        <meta name="author" content={SITE.publisherName ?? "Saku Studios"} />

        <!-- Favicons -->
        <link rel="icon" href="/favicon.ico" sizes="any" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
        <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
        <link rel="manifest" href="/site.webmanifest" />

        <meta name="theme-color" content="#4f46e5" />

        <!-- Google Search Console -->
        <meta
            name="google-site-verification"
            content="Z-y56dqDLvpkE2AWPxyYTlb8y8N2dch1mp7wnUYlt1I"
        />

        <!-- Open Graph -->
        <meta property="og:type" content="website" />
        <meta property="og:site_name" content={SITE.name} />
        <meta property="og:title" content={fullTitle} />
        <meta property="og:description" content={finalDescription} />
        <meta property="og:url" content={canonicalUrl} />
        <meta property="og:image" content={ogImageAbs} />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
        <meta property="og:locale" content={lang === "tr" ? "tr_TR" : "en_US"} />

        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={fullTitle} />
        <meta name="twitter:description" content={finalDescription} />
        <meta name="twitter:image" content={ogImageAbs} />
        {SITE.twitter && <meta name="twitter:site" content={SITE.twitter} />}

        <!-- ✅ JSON-LD: set:html YOK. Boşsa hiç basma. -->
        {jsonLdString && (
            <script type="application/ld+json">{jsonLdString}</script>
        )}
    </head>

    <body>
        <main>
            <slot />
        </main>

        <script is:inline>
            const topbar = document.querySelector(".topbar");
            let lastState = false;

            window.addEventListener("scroll", () => {
                if (!topbar) return;
                const compact = window.scrollY > 24;

                if (compact !== lastState) {
                    topbar.classList.toggle("is-compact", compact);
                    lastState = compact;
                }
            });
        </script>
    </body>
</html>
